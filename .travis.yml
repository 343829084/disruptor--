# taken from https://github.com/ldionne/hana/blob/master/.travis.yml

language: c++
compiler: clang
os: linux
sudo: false

matrix:
  include:
    # clang 3.5
    - env: CLANG_VERSION=3.5
      addons: &clang35
        apt:
          packages:
            - clang-3.5
            - valgrind
            - libboost-dev
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-precise-3.5

    # clang 3.6
    - env: CLANG_VERSION=3.6
      addons: &clang36
        apt:
          packages:
            - clang-3.6
            - valgrind
            - libboost-dev
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-precise-3.6

install:
  ############################################################################
  # All the dependencies are installed to the deps/ subdirectory.
  ############################################################################
  - DEPS_DIR="${PWD}/deps"
  - mkdir ${DEPS_DIR} && cd ${DEPS_DIR}

  ############################################################################
  # Install a recent CMake
  ############################################################################
  - CMAKE_URL=http://www.cmake.org/files/v3.2/cmake-3.2.1-Linux-x86_64.tar.gz
  - mkdir cmake
  - travis_retry wget --quiet -O - ${CMAKE_URL} | tar --strip-components=1 -xz -C cmake
  - export PATH=${PWD}/cmake/bin:${PATH}

  ############################################################################
  # Install libc++ and libc++abi
  # Note: We install libc++[abi] 3.6 even with Clang 3.5, because the 3.5
  #       version does not seem to provide <ciso646>, which we require.
  ############################################################################
  - LLVM_URL="http://llvm.org/releases/3.6.1/llvm-3.6.1.src.tar.xz"
  - LIBCXX_URL="http://llvm.org/releases/3.6.1/libcxx-3.6.1.src.tar.xz"
  - LIBCXXABI_URL="http://llvm.org/releases/3.6.1/libcxxabi-3.6.1.src.tar.xz"
  - TAR_FMT="-xJ"
  - mkdir -p llvm llvm/build llvm/projects/libcxx llvm/projects/libcxxabi
  - travis_retry wget --quiet -O - ${LLVM_URL} | tar --strip-components=1 ${TAR_FMT} -C llvm
  - travis_retry wget --quiet -O - ${LIBCXX_URL} | tar --strip-components=1 ${TAR_FMT} -C llvm/projects/libcxx
  - travis_retry wget --quiet -O - ${LIBCXXABI_URL} | tar --strip-components=1 ${TAR_FMT} -C llvm/projects/libcxxabi
  - (cd llvm/build && cmake .. -DCMAKE_CXX_COMPILER=clang++ && make cxx -j2)

before_script:
  ############################################################################
  # Go back to the root of the project.
  ############################################################################
  - cd ${TRAVIS_BUILD_DIR}

  ############################################################################
  # Setup the build directory
  ############################################################################
  - mkdir build
  - cd build
  - export CXXFLAGS="-I ${DEPS_DIR}/llvm/build/include/c++/v1"
  - export LDFLAGS="-L ${DEPS_DIR}/llvm/build/lib -l c++ -l c++abi"
  - export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${DEPS_DIR}/llvm/build/lib"
  - cmake .. -DCMAKE_CXX_COMPILER=clang++-${CLANG_VERSION} -DBOOST_ROOT=${DEPS_DIR}/boost -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DBOOST_HANA_ENABLE_MEMCHECK=ON -DBOOST_HANA_ENABLE_WERROR=ON

script:
  ############################################################################
  # Build and run the unit tests and examples.
  ############################################################################
  - export CTEST_PARALLEL_LEVEL=2 # Run unit tests on two cores
  - make tests -k -j3
  - make check -k
